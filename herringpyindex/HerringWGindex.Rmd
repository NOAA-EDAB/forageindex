---
title: "Herring index from stomachs"
subtitle: "Data updated through 2022"
author: "Sarah Gaichas and James Gartland, based on work by Elizabeth Ng"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2: 
    toc: true
    toc_float: true
    code_fold: hide
  bookdown::word_document2:
    toc: true
  bookdown::pdf_document2:
    includes: 
       in_header: latex/header1.tex
    keep_tex: true
link-citations: yes
bibliography: Exported items.bib
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, # no code blocks in word doc
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
theme_set(theme_bw())
library(here)

library(officedown)
library(officer)
library(flextable)
# op_section <- prop_section(type = "continuous")
# close_section <- prop_section(
#     page_size = page_size(orient = "landscape"), 
#     type = "continuous")

```

# Summary

This index uses herring observed in predator stomachs to evaluate potential herring trends for the 2025 RT assessment.

Methods are based on the forage index for Bluefish [@gaichas_assessing_2023] and the State of the Ecosystem [forage index](https://noaa-edab.github.io/catalog/forage-fish-index.html). 

Will discuss a good starting point with the team, but for now start at 1973 and use data through 2022.

# Workflow

Operational updates to the forage index submitted to the State of the Ecosystem report are in the forageindex github repository: https://github.com/NOAA-EDAB/forageindex

Data input files are in the folder `fhdat` and were processed with the script `VASTherringWG_ProcessInputDat.R` in that folder: https://github.com/NOAA-EDAB/forageindex/blob/main/fhdat/VASTherringWG_ProcessInputDat.R

```{r, code = readLines("https://raw.githubusercontent.com/NOAA-EDAB/forageindex/main/fhdat/VASTherringWG_ProcessInputDat.R"), eval=FALSE}

```


VAST models were run using the script `VASTunivariate_seasonalherringindex.R` in the folder `VASTscripts`: https://github.com/NOAA-EDAB/forageindex/blob/main/VASTscripts/VASTunivariate_seasonalherringindex.R 

```{r, code = readLines("https://raw.githubusercontent.com/NOAA-EDAB/forageindex/main/VASTscripts/VASTunivariate_seasonalherringindex.R"), eval=FALSE}

```

# Results

## How many piscivore locations had herring?

Not that many. Seems a spring model will run anyway using the forage index configuration but a fall model will not.

```{r}
herringagg_stn <- readRDS(here::here("fhdat/herringagg_stn_all_OISST_1982-2022.rds"))

# make SST column that uses surftemp unless missing or 0
# there are 3 surftemp 0 values in the dataset, all with oisst > 15
herringagg_stn <- herringagg_stn %>%
  dplyr::mutate(sstfill = ifelse((is.na(surftemp)|surftemp==0), oisst, surftemp))

#herringagg_stn <- bluepyagg_pred_stn

# filter to assessment years at Tony's suggestion

# code Vessel as AL=0, HB=1, NEAMAP=2

herringagg_stn_all <- herringagg_stn %>%
  #ungroup() %>%
  #filter(season_ng == "FALL") |>
  #,year > 1984) %>%
  mutate(AreaSwept_km2 = 1, #Elizabeth's code
         #declon = -declon already done before neamap merge
         Vessel = as.numeric(as.factor(vessel))-1
  ) %>% 
  dplyr::select(Catch_g = meanherringwt, #use bluepywt for individuals input in example
                Year = year,
                Vessel,
                AreaSwept_km2,
                Lat = declat,
                Lon = declon,
                meanpisclen,
                npiscsp,
                #bottemp, #this leaves out many stations for NEFSC
                #surftemp, #this leaves out many stations for NEFSC
                #oisst, #leaves out everything before 1982
                sstfill,
                season_ng
  ) %>%
  na.omit() %>%
  as.data.frame()

nonzeroherring <- herringagg_stn_all |>
  dplyr::filter(Catch_g > 0) |> 
  dplyr::group_by(season_ng, Year) |> 
  dplyr::summarise(n = dplyr::n()) |>
  tidyr::pivot_wider(names_from = "season_ng", names_prefix = "Herring", values_from = "n")

tows <- herringagg_stn_all |>
  dplyr::group_by(season_ng, Year) |> 
  dplyr::summarise(n = dplyr::n()) |>
  tidyr::pivot_wider(names_from = "season_ng", names_prefix = "Total", values_from = "n")

pisctows <- dplyr::left_join(tows, nonzeroherring) |>
  dplyr::select(Year, TotalSPRING, HerringSPRING, TotalFALL, HerringFALL)

tab1 <- flextable::flextable(pisctows) |>
  flextable::set_caption("Number of piscivore stomach locations by season and year (TotalSPRING and TotalFALL), and number of piscivore stomach locations having nonzero herring prey (HerringSPRING and HerringFALL).") 

flextable::colformat_double(tab1, big.mark = "", digits = 0)

```


## Fall model using forage index setup: failed

About the same number of positive observations in spring and fall. 

```
List of estimated fixed and random effects:
    Coefficient_name Number_of_coefficients   Type
1           beta1_ft                     48  Fixed
2           beta2_ft                     48  Fixed
3       L_epsilon1_z                      1  Fixed
4       L_epsilon2_z                      1  Fixed
5         L_omega1_z                      1  Fixed
6         L_omega2_z                      1  Fixed
7          lambda1_k                      3  Fixed
8          lambda2_k                      3  Fixed
9         ln_H_input                      2  Fixed
10         logkappa1                      1  Fixed
11         logkappa2                      1  Fixed
12         logSigmaM                      1  Fixed
13 Epsiloninput1_sff                  27750 Random
14 Epsiloninput2_sff                  27750 Random
15    Omegainput1_sf                    555 Random
16    Omegainput2_sf                    555 Random

### Checking model at initial values
All fixed effects have a nonzero gradient

... After 167 iterations...

The following parameters appear to be approaching zero:
          Param starting_value Lower           MLE Upper final_gradient
55 L_epsilon1_z              1  -Inf -8.171138e-07   Inf  -7.579271e-05
Please turn off factor-model variance parameters `L_` that are approaching zero and re-run the model

Error: Please change model structure to avoid problems with parameter estimates and then re-try; see details in `?check_fit`
In addition: Warning message:
In nlminb(start = startpar, objective = fn, gradient = gr, control = nlminb.control,  :
  NA/NaN function evaluation
```
Trying spring model

## Spring results using forage index setup: ran

Check diagnostics.

Abundance index:

```{r}
SOEinputs <- function(infile, season, outfile) {
  
  splitoutput <- read.csv(infile)
  
  # warning, hardcoded. obviously
  stratlook <- data.frame(Stratum = c("Stratum_1",
                                      "Stratum_2",
                                      "Stratum_3",
                                      "Stratum_4",
                                      "Stratum_5",
                                      "Stratum_6",
                                      "Stratum_7",
                                      "Stratum_8",
                                      "Stratum_9",
                                      "Stratum_10",
                                      "Stratum_11",
                                      "Stratum_12",
                                      "Stratum_13",
                                      "Stratum_14",
                                      "Stratum_15"),
                          Region  = c("AllEPU", 
                                      "MABGB", 
                                      "MABGBstate", 
                                      "MABGBfed", 
                                      "MAB",
                                      "GB",
                                      "GOM",
                                      "bfall",
                                      "bfin",
                                      "bfoff",
                                      "MABGBalbinshore",
                                      "MABGBothoffshore",
                                      "albbfin",
                                      "albbfall",
                                      "allother"))
  
  forageindex <- splitoutput %>%
    left_join(stratlook) %>%
    dplyr::select(Time, 
                  EPU = Region, 
                  "Forage Fish Biomass Estimate" = Estimate, 
                  "Forage Fish Biomass Estimate SE" = Std..Error.for.Estimate) %>%
    tidyr::pivot_longer(c("Forage Fish Biomass Estimate", "Forage Fish Biomass Estimate SE"), 
                        names_to = "Var", values_to = "Value") %>%
    dplyr::filter(EPU %in% c("MAB", "GB", "GOM", "AllEPU")) %>%
    dplyr::mutate(Units = "relative grams per stomach") %>%
    dplyr::select(Time, Var, Value, EPU, Units)
  
  forageindex$Var <- stringr::str_c(season, forageindex$Var, sep = " ")
  
  #readr::write_csv(forageindex, outfile)
  saveRDS(forageindex, outfile)
  
} 


# make data files

SOEinputs(infile = here::here("herringpyindex/allagg_spring_500_lennosst_ALLsplit_biascorrect/Index.csv"),
          season = "Spring", 
           outfile = here::here("herringpyindex/springherringindex.rds"))


forageindex <- readRDS(here::here("herringpyindex/springherringindex.rds"))

# test plot
foragewide <- forageindex %>%
  pivot_wider(names_from = Var, values_from = Value)


ggplot(foragewide, aes(x=Time, y=`Spring Forage Fish Biomass Estimate`, colour = EPU)) +
  geom_errorbar(aes(ymin=`Spring Forage Fish Biomass Estimate`+`Spring Forage Fish Biomass Estimate SE`,
                    ymax=`Spring Forage Fish Biomass Estimate`-`Spring Forage Fish Biomass Estimate SE`))+
  geom_point()+
  geom_line()


```
Log density pattern:

```{r}
knitr::include_graphics(here::here("herringpyindex/allagg_spring_500_lennosst_ALLsplit_biascorrect/ln_density-predicted.png"))
```

Spatial residuals:

```{r}
knitr::include_graphics(here::here("herringpyindex/allagg_spring_500_lennosst_ALLsplit_biascorrect/quantile_residuals_on_map.png"))
```

How much data in spring?

```{r}
knitr::include_graphics(here::here("herringpyindex/allagg_spring_500_lennosst_ALLsplit_biascorrect/Data_by_year.png"))
```


## Model selection

Same initial as forage index to see if spatial RE, spatio-temporal RE, and aniso make sense.


# References

